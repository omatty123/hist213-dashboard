<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HIST 213 - Teaching Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root { --bg: #f5f5f7; --surface: #fff; --surface-alt: #fafafa; --border: #e5e5e5; --text: #1d1d1f; --text-muted: #86868b; --accent: #0071e3; --accent-light: #e1f0ff; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); }
    header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .course-title { font-weight: 600; font-size: 15px; }
    .plate-nav { display: flex; align-items: center; gap: 6px; }
    .plate-nav button { background: none; border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
    .header-tools { display: flex; gap: 8px; }
    .header-tools button { background: var(--surface-alt); border: 1px solid var(--border); padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; }
    main { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .roster-strip { background: var(--surface); border-radius: 10px; padding: 16px 20px; margin-bottom: 20px; }
    .roster-strip h3 { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); margin-bottom: 14px; font-weight: 500; }
    .roster-row { display: flex; gap: 14px; overflow-x: auto; padding-bottom: 4px; }
    .student-nameplate {
      display: flex; flex-direction: column; align-items: center; gap: 8px;
      background: linear-gradient(145deg, #fefefe, #f5f5f5);
      padding: 14px 18px 12px;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);
      border: 1px solid rgba(0,0,0,0.06);
      min-width: 90px;
      position: relative;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .student-nameplate:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.08); }
    .student-nameplate::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
      background: linear-gradient(90deg, #8b4513, #a0522d, #8b4513);
      border-radius: 4px 4px 0 0;
    }
    .student-nameplate img {
      width: 48px; height: 48px; border-radius: 50%; object-fit: cover;
      border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .student-nameplate .name {
      font-size: 13px; font-weight: 600; text-align: center;
      color: var(--text); letter-spacing: 0.3px;
    }
    .student-nameplate .pronouns {
      font-size: 10px; color: var(--text-muted);
      font-style: italic; margin-top: -4px;
    }
    .prep-container { background: var(--surface); border-radius: 12px; overflow: hidden; }
    .prep-header {
      background: linear-gradient(165deg, #2c3e50 0%, #34495e 40%, #4a5568 70%, #5a6673 100%);
      color: white; padding: 24px 28px; position: relative; overflow: hidden;
    }
    .prep-header::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120"><path fill="rgba(255,255,255,0.03)" d="M0,60 C150,90 350,30 500,60 C650,90 850,30 1000,60 C1150,90 1200,60 1200,60 L1200,120 L0,120 Z"/><path fill="rgba(255,255,255,0.02)" d="M0,80 C200,110 400,50 600,80 C800,110 1000,50 1200,80 L1200,120 L0,120 Z"/></svg>');
      background-position: bottom; background-repeat: no-repeat; background-size: cover;
      pointer-events: none;
    }
    .prep-header::after {
      content: ''; position: absolute; top: 12px; right: 20px;
      width: 80px; height: 80px; opacity: 0.08;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="none" stroke="white" stroke-width="2"/><circle cx="50" cy="50" r="35" fill="none" stroke="white" stroke-width="1"/><path d="M50,10 Q70,50 50,90 Q30,50 50,10" fill="none" stroke="white" stroke-width="1.5"/></svg>');
    }
    .prep-header .week-theme {
      font-size: 10px; text-transform: uppercase; letter-spacing: 2px;
      color: #c9a962; margin-bottom: 6px; font-weight: 500; position: relative;
    }
    .prep-header h1 {
      font-size: 26px; font-weight: 300; margin-bottom: 6px;
      letter-spacing: 0.5px; position: relative;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .prep-header .date { font-size: 13px; opacity: 0.75; font-weight: 300; position: relative; letter-spacing: 0.3px; }
    .prep-header .ebrey {
      display: inline-block; background: rgba(201,169,98,0.2);
      border: 1px solid rgba(201,169,98,0.3);
      padding: 5px 12px; border-radius: 2px; font-size: 11px; margin-top: 12px;
      color: #f0e6d0; position: relative; letter-spacing: 0.3px;
    }
    .prep-body { display: grid; grid-template-columns: 1fr 340px; min-height: 400px; }
    .prep-main { padding: 24px; border-right: 1px solid var(--border); }
    .prep-sidebar { padding: 24px; background: var(--surface-alt); }
    .section-title { font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; font-weight: 600; }
    /* Base reading card */
    .reading-card {
      display: block; padding: 16px 18px; margin-bottom: 12px;
      text-decoration: none; color: var(--text);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      position: relative;
    }
    .reading-card:hover { transform: translateY(-2px); }
    .reading-card .type-badge { display: inline-block; font-size: 9px; font-weight: 600; text-transform: uppercase; padding: 3px 8px; border-radius: 3px; margin-bottom: 8px; }
    .reading-card .title { font-size: 14px; font-weight: 600; margin-bottom: 5px; line-height: 1.3; }
    .reading-card .author { font-size: 12px; margin-bottom: 3px; }
    .reading-card .source { font-size: 11px; }
    /* Primary source - aged document feel */
    .reading-card.primary {
      background: linear-gradient(135deg, #faf6f0 0%, #f5efe6 50%, #f0ead8 100%);
      border: 1px solid #d4c9b5;
      border-radius: 2px;
      box-shadow: 2px 3px 8px rgba(139,90,43,0.12), inset 0 0 30px rgba(139,90,43,0.03);
    }
    .reading-card.primary::before {
      content: ''; position: absolute; top: 8px; right: 8px;
      width: 24px; height: 24px; opacity: 0.15;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%238B4513"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>');
    }
    .reading-card.primary:hover { box-shadow: 3px 5px 12px rgba(139,90,43,0.18); }
    .reading-card.primary .type-badge { background: #8b4513; color: #fff; }
    .reading-card.primary .title { font-family: Georgia, 'Times New Roman', serif; }
    .reading-card.primary .author, .reading-card.primary .source { color: #7a6b5a; }
    /* Theoretical - clean academic paper */
    .reading-card.theoretical {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-left: 4px solid #5c6bc0;
      border-radius: 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      background-image: linear-gradient(rgba(92,107,192,0.03) 1px, transparent 1px);
      background-size: 100% 24px;
    }
    .reading-card.theoretical::before {
      content: ''; position: absolute; top: 8px; right: 8px;
      width: 20px; height: 20px; opacity: 0.25;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%235c6bc0"><path d="M12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/><path d="M12 16.5l-7-3.82V17c0 2.5 3.5 4 7 4s7-1.5 7-4v-4.32l-7 3.82z"/></svg>');
    }
    .reading-card.theoretical:hover { box-shadow: 0 3px 10px rgba(92,107,192,0.15); }
    .reading-card.theoretical .type-badge { background: #5c6bc0; color: #fff; }
    .reading-card.theoretical .title { font-weight: 700; letter-spacing: -0.3px; }
    .reading-card.theoretical .author { color: #5c6bc0; font-weight: 500; }
    .reading-card.theoretical .source { color: #888; }
    /* Secondary source - balanced scholarly */
    .reading-card.secondary {
      background: linear-gradient(to bottom, #fff 0%, #fafafa 100%);
      border: 1px solid #e8e8e8;
      border-left: 3px solid #26a69a;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }
    .reading-card.secondary::before {
      content: ''; position: absolute; top: 8px; right: 8px;
      width: 20px; height: 20px; opacity: 0.2;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2326a69a"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>');
    }
    .reading-card.secondary:hover { box-shadow: 0 4px 12px rgba(38,166,154,0.15); }
    .reading-card.secondary .type-badge { background: #26a69a; color: #fff; }
    .reading-card.secondary .author { color: #26a69a; }
    .reading-card.secondary .source { color: #888; }
    .web-links { margin-top: 16px; }
    .web-link { display: inline-block; font-size: 11px; background: var(--surface-alt); border: 1px solid var(--border); padding: 6px 10px; border-radius: 6px; margin: 0 6px 6px 0; color: var(--accent); text-decoration: none; }
    .upcoming-card { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 14px; margin-bottom: 16px; }
    .upcoming-card .plate-num { font-size: 13px; font-weight: 600; color: var(--accent); }
    .upcoming-card .topic { font-size: 13px; margin-top: 4px; }
    .upcoming-card .date { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
    .notes-box { background: #fffde7; border: 1px solid #fff59d; border-radius: 8px; padding: 14px; font-size: 12px; margin-bottom: 16px; }
    .notes-box.special { background: #fff3e0; border-color: #ffcc80; }
    .assignment-box { background: #e8f5e9; border: 1px solid #a5d6a7; border-radius: 8px; padding: 14px; margin-bottom: 16px; }
    .assignment-box .label { font-size: 10px; color: #2e7d32; text-transform: uppercase; }
    .assignment-box .name { font-size: 14px; font-weight: 600; color: #1b5e20; }
    .assignment-box .due { font-size: 12px; color: #388e3c; }
    .film-box { background: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; padding: 14px; margin-bottom: 16px; }
    .film-box a { color: #7b1fa2; }
    .no-class-banner { background: #ffebee; color: #c62828; padding: 40px; text-align: center; font-size: 16px; }
    .prep-section { margin-bottom: 20px; }
    .prep-section h3 { font-size: 12px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; letter-spacing: 0.5px; }
    .prep-summary { background: var(--surface-alt); border-radius: 8px; padding: 16px; line-height: 1.6; font-size: 13px; white-space: pre-wrap; }
    .keywords-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .keywords-table th { background: var(--accent-light); color: var(--accent); padding: 8px; text-align: left; }
    .keywords-table td { padding: 8px; border-bottom: 1px solid var(--border); }
    .passage-card { background: var(--surface-alt); border-left: 3px solid var(--accent); padding: 12px 16px; margin-bottom: 10px; border-radius: 0 6px 6px 0; }
    .passage-card blockquote { font-style: italic; font-size: 13px; line-height: 1.5; margin: 0 0 8px 0; }
    .passage-card .source { font-size: 11px; color: var(--text-muted); }
    .ppt-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: var(--border); border-radius: 6px; overflow: hidden; }
    .ppt-grid .header { background: var(--accent-light); padding: 8px; text-align: center; font-weight: 600; font-size: 12px; color: var(--accent); }
    .ppt-grid .cell { background: var(--surface); padding: 10px; font-size: 12px; }
    .question-card { background: var(--surface-alt); border-radius: 6px; padding: 12px; margin-bottom: 10px; }
    .question-card .q { font-weight: 500; margin-bottom: 6px; font-size: 13px; }
    .question-card .a { font-size: 12px; color: var(--text-muted); padding-left: 10px; border-left: 2px solid var(--accent); }
    .timeline-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .timeline-table th { background: var(--accent-light); color: var(--accent); padding: 8px; text-align: left; width: 100px; }
    .timeline-table td { padding: 8px; border-bottom: 1px solid var(--border); }
    .connection-item { background: var(--surface-alt); border-radius: 6px; padding: 10px 12px; margin-bottom: 8px; font-size: 12px; }
    .connection-item strong { color: var(--accent); }
    .teaching-note { display: flex; gap: 8px; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
    .teaching-note:last-child { border-bottom: none; }
    .teaching-note::before { content: "‚Ä¢"; color: var(--accent); font-weight: bold; }
    .sage-badge { display: inline-block; font-size: 9px; background: var(--accent-light); color: var(--accent); padding: 2px 8px; border-radius: 10px; font-weight: 600; margin-left: 8px; }
    /* Reading Analysis Cards */
    .reading-analysis { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 16px; overflow: hidden; }
    .reading-analysis-header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 14px 18px; }
    .reading-analysis-header .title { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
    .reading-analysis-header .meta { font-size: 11px; opacity: 0.85; }
    .reading-analysis-header .type-pill { display: inline-block; font-size: 9px; padding: 2px 8px; border-radius: 10px; margin-left: 8px; text-transform: uppercase; }
    .reading-analysis-header .type-pill.primary { background: rgba(139,69,19,0.8); }
    .reading-analysis-header .type-pill.secondary { background: rgba(38,166,154,0.8); }
    .reading-analysis-header .type-pill.theoretical { background: rgba(92,107,192,0.8); }
    .reading-analysis-body { padding: 16px 18px; }
    .reading-analysis-body .summary { font-size: 13px; line-height: 1.6; margin-bottom: 14px; color: var(--text); }
    .reading-analysis-body .subsection { margin-bottom: 14px; }
    .reading-analysis-body .subsection-title { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
    .reading-analysis-body .quote-item { background: var(--surface-alt); border-left: 3px solid var(--accent); padding: 10px 14px; margin-bottom: 8px; border-radius: 0 6px 6px 0; }
    .reading-analysis-body .quote-item blockquote { font-style: italic; font-size: 13px; margin: 0 0 4px 0; line-height: 1.5; }
    .reading-analysis-body .quote-item .page { font-size: 10px; color: var(--text-muted); }
    .reading-analysis-body .example-list, .reading-analysis-body .connection-list { list-style: none; padding: 0; }
    .reading-analysis-body .example-list li, .reading-analysis-body .connection-list li { font-size: 12px; padding: 6px 0 6px 16px; position: relative; line-height: 1.5; }
    .reading-analysis-body .example-list li::before { content: "‚Üí"; position: absolute; left: 0; color: var(--accent); }
    .reading-analysis-body .connection-list li::before { content: "‚ü∑"; position: absolute; left: 0; color: #26a69a; }
    .synthesis-box { background: linear-gradient(135deg, #f8f9fa, #fff); border: 1px solid var(--border); border-left: 4px solid #c9a962; border-radius: 8px; padding: 16px 18px; margin-bottom: 16px; }
    .synthesis-box h3 { font-size: 13px; color: #8b6914; margin-bottom: 10px; }
    .synthesis-box p { font-size: 13px; line-height: 1.6; margin: 0; white-space: pre-wrap; }
    .map-container { height: 300px; border-radius: 8px; overflow: hidden; margin-bottom: 16px; border: 1px solid var(--border); }
    .map-container .leaflet-container { height: 100%; width: 100%; }
    .map-legend { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 8px; font-size: 11px; }
    .map-legend-item { display: flex; align-items: center; gap: 4px; }
    .map-legend-dot { width: 10px; height: 10px; border-radius: 50%; }
    .plate-selector { position: relative; }
    .plate-dropdown { position: absolute; top: 100%; left: 0; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; min-width: 450px; max-height: 450px; overflow-y: auto; display: none; z-index: 200; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
    .plate-dropdown.open { display: block; }
    .plate-option { padding: 10px 14px; cursor: pointer; font-size: 12px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); }
    .plate-option:hover { background: var(--surface-alt); }
    .plate-option.active { background: var(--accent-light); }
    .plate-option.no-class { color: var(--text-muted); font-style: italic; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal { background: var(--surface); border-radius: 12px; width: 400px; }
    .modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; }
    .modal-body { padding: 20px; }
    .timer-display { font-size: 72px; font-weight: 200; text-align: center; padding: 30px 0; font-family: monospace; }
    .timer-controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 16px; }
    .timer-presets { display: flex; gap: 6px; justify-content: center; }
    .btn { padding: 8px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-secondary { background: var(--surface-alt); border: 1px solid var(--border); }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <span class="course-title">HIST 213 ¬∑ East Asia in the Modern World</span>
      <div class="plate-nav">
        <button onclick="prevPlate()">‚Üê</button>
        <div class="plate-selector">
          <button onclick="togglePlateDropdown()" style="min-width:120px"><span id="currentPlate">Day 1</span></button>
          <div class="plate-dropdown" id="plateDropdown"></div>
        </div>
        <button onclick="nextPlate()">‚Üí</button>
      </div>
    </div>
    <div class="header-tools">
      <button id="enrichmentBtn" onclick="openEnrichment()" style="display:none">‚ú® Enrichment</button>
      <button id="printWorksheetBtn" onclick="openPrintWorksheet()" style="display:none">üñ®Ô∏è Print Worksheet</button>
      <button onclick="window.open('resources.html','_blank')">üìö Resources</button>
      <button onclick="openTimerModal()">‚è±Ô∏è Timer</button>
      <button onclick="window.open('https://docs.google.com/document/d/e/2PACX-1vRUiKkQiUJqbfQUdtSPkufXE1rnxvSV0riyoD-pS2NXToPGxWssQ5Mp18VijPCA-w/pub','_blank')">üìÑ Syllabus</button>
    </div>
  </header>
  <main>
    <div class="roster-strip">
      <h3>Class Roster</h3>
      <div class="roster-row" id="rosterRow"></div>
    </div>
    <div class="prep-container">
      <div class="prep-header">
        <div class="week-theme" id="weekTheme">Week 1</div>
        <h1 id="plateTitle">Day 1: Introduction</h1>
        <div class="date" id="plateDate"></div>
        <div class="ebrey" id="ebreyRef" style="display:none"></div>
      </div>
      <div class="prep-body">
        <div class="prep-main" id="prepMain"></div>
        <div class="prep-sidebar" id="prepSidebar"></div>
      </div>
    </div>
  </main>
  <div class="modal-overlay" id="timerModal">
    <div class="modal">
      <div class="modal-header"><h2>Class Timer</h2><button class="modal-close" onclick="closeTimerModal()">√ó</button></div>
      <div class="modal-body">
        <div class="timer-display" id="timerDisplay">10:00</div>
        <div class="timer-controls">
          <button class="btn btn-primary" onclick="startTimer()">‚ñ∂ Start</button>
          <button class="btn btn-secondary" onclick="pauseTimer()">‚è∏ Pause</button>
          <button class="btn btn-secondary" onclick="resetTimer()">‚Ü∫ Reset</button>
        </div>
        <div class="timer-presets">
          <button class="btn btn-secondary" onclick="setTimer(5)">5m</button>
          <button class="btn btn-secondary" onclick="setTimer(10)">10m</button>
          <button class="btn btn-secondary" onclick="setTimer(15)">15m</button>
          <button class="btn btn-secondary" onclick="setTimer(20)">20m</button>
        </div>
      </div>
    </div>
  </div>
<script>
var students = [
  {id:"1",lastName:"Good",firstName:"Susanna",pronouns:"",photo:"photos/good_susanna.png"},
  {id:"2",lastName:"Jeong",firstName:"Jessy",preferredName:"Yunji",pronouns:"",photo:"photos/jeong_jessy.png"},
  {id:"3",lastName:"Kypriotis",firstName:"Nik",pronouns:"He/Him/His",photo:"photos/kypriotis_nik.png"},
  {id:"4",lastName:"Pick",firstName:"Isabelle",pronouns:"She/Her/Hers",photo:"photos/pick_isabelle.png"},
  {id:"5",lastName:"Sweeney",firstName:"Em",pronouns:"They/Them/Theirs",photo:"photos/sweeney_em.png"},
  {id:"6",lastName:"Valdez",firstName:"Eliel",pronouns:"He/Him/His",photo:"photos/valdez_eliel.png"},
  {id:"7",lastName:"Williams",firstName:"Sam",pronouns:"",photo:"photos/williams_sam.png"},
  {id:"8",lastName:"Yang",firstName:"Juchan",pronouns:"",photo:"photos/yang_juchan.png"}
];

var plates = [
  {plate:1,date:"2026-01-05",day:"Monday",week:1,topic:"Introduction to the class, geography of East Asia",theme:"East Asia - who, what, where?",ebrey:null,readings:[],notes:"First day of class"},
  {plate:2,date:"2026-01-07",day:"Wednesday",week:1,topic:"East Asian Language, Religion, Culture",theme:"East Asia - who, what, where?",ebrey:null,readings:[{title:"Basic Identities",author:"Schoppa",source:"East Asia",pages:"2-23",type:"secondary",url:"https://drive.google.com/file/d/1jcWmYXBcgwx7NqnqHV1vRETgVFYTNHNC/view"}],webLinks:[{title:"Chinese Script",url:"http://www.omniglot.com/writing/chinese.htm"},{title:"Korean",url:"http://www.omniglot.com/writing/korean.htm"}]},
  {plate:3,date:"2026-01-09",day:"Friday",week:1,topic:"What is Modernity?",theme:"Making sense of modernity",ebrey:null,readings:[{title:"Introduction to Real World History vs. Eurocentric Social Theory",author:"Frank",source:"ReORIENT",pages:"1-51",type:"theoretical",url:"https://drive.google.com/file/d/1PlgdAe9H3K68FktBJ_s02OvKmZeatfKW/view"}],webLinks:[{title:"Asia for Educators",url:"http://afe.easia.columbia.edu/chinawh/index.html"}],special:"THEORETICAL READING - skim for thesis"},
  {plate:4,date:"2026-01-12",day:"Monday",week:2,topic:"Joseon Invaded",theme:"Imjin War / Fall of Ming",ebrey:"Ch. 15: 247-254",readings:[{title:"The Korean War (Imjin War)",source:"SJT",pages:"465-472",type:"primary",url:"https://drive.google.com/file/d/1N-yBVjsZABrL9jY5onUV1eMLK9vy0tMK/view"},{title:"Crouching Tigers, Secret Weapons",author:"Swope",type:"theoretical",url:"https://drive.google.com/file/d/1N-yBVjsZABrL9jY5onUV1eMLK9vy0tMK/view"}],special:"THEORETICAL READING"},
  {plate:5,date:"2026-01-14",day:"Wednesday",week:2,topic:"Rise of Qing, Creation of Manchu Empire",theme:"Fall of Ming and Rise of Qing",ebrey:"Ch. 16",readings:[{title:"Fall of the Ming",source:"SMC",pages:"4-14",type:"primary",url:"https://drive.google.com/file/d/1UXhtVQLFsqorBWNBIfUNiDNDopryYp2k/view"},{title:"Horrid Beyond Description",author:"Struve",source:"Ming-Qing Cataclysm",type:"primary",url:"https://drive.google.com/file/d/1WMpbuLVx1eBXsAMGE30dKoY1-fvRl4NF/view"}]},
  {plate:6,date:"2026-01-16",day:"Friday",week:2,topic:"Qing's Encounter with the West",theme:"Fall of Ming and Rise of Qing",ebrey:null,readings:[{title:"Rise of Qing",source:"SMC",pages:"21-39",type:"primary",url:"https://drive.google.com/file/d/1vfrDl5y84ceFKWTcarkCiQOTyLgHAiYc/view"},{title:"Qianlong's Letter to King George III",author:"Emperor Qianlong",type:"primary",url:"https://drive.google.com/file/d/19LWhhqRRFqTJZ1wW38UcYEIBXnUc3NxH/view"}],webLinks:[{title:"Macartney Mission",url:"http://www.fordham.edu/halsall/mod/1792macartney.asp"}]},
  {plate:null,date:"2026-01-19",day:"Monday",week:3,topic:"MLK Day",theme:"No Class",ebrey:null,readings:[],noClass:true},
  {plate:7,date:"2026-01-21",day:"Wednesday",week:3,topic:"Joseon Reform",theme:"Joseon reform / Tokugawa",ebrey:"Ch. 15: 254-263",readings:[{title:"On Reform",author:"Yu Hyongwon et al.",source:"SKT",pages:"70-116",type:"primary",url:"https://drive.google.com/file/d/13gb4xRSSG_-QwtxZTaTVXIA3ar6GMzVK/view"}],webLinks:[{title:"Chos≈èn Maritime Trade Routes Map",url:"print/choson-trade-routes.html"}]},
  {plate:8,date:"2026-01-23",day:"Friday",week:3,topic:"Rise of Tokugawa",theme:"Joseon reform / Tokugawa",ebrey:"Ch. 17",readings:[{title:"Military Government / Laws of Military Households",author:"Tokugawa Ieyasu",source:"SJT",type:"primary",url:"https://drive.google.com/file/d/1MD8dyzEC2mn2Hqk6smdQOv3TA9fJe52B/view"}],webLinks:[{title:"Urban Giants Population Map",url:"print/east-asia-population-1700.html"}],assignment:{name:"Project #1",due:"2026-01-25",dueDay:"Sunday"}},
  {plate:9,date:"2026-01-26",day:"Monday",week:4,topic:"Presentation brainstorm / Current events",theme:"Qing and Tokugawa vs West",ebrey:null,readings:[],notes:"Discussion day"},
  {plate:10,date:"2026-01-28",day:"Wednesday",week:4,topic:"Qing vs. the West",theme:"Qing and Tokugawa vs West",ebrey:"Connections 306-313, Ch. 18",readings:[{title:"Commissioner Lin's Letter to Queen Victoria",author:"Lin Zexu",type:"primary",url:"https://drive.google.com/file/d/1vF0d7BWHCd2i0Hu08LkYbAhnNkepH80Q/view"},{title:"Treaty of Nanjing",type:"primary",url:"https://drive.google.com/file/d/1xJOTI4TbondCXKURtIKOR6LdF4kjaZ-i/view"}],webLinks:[{title:"MIT: First Unequal Treaty",url:"https://visualizingcultures.mit.edu/opium_wars_01/ow1_essay04.html"}]},
  {plate:11,date:"2026-01-30",day:"Friday",week:4,topic:"Tokugawa vs. the West",theme:"Qing and Tokugawa vs West",ebrey:"Ch. 19",readings:[{title:"Harris Treaty of 1858",type:"primary",url:"https://drive.google.com/file/d/1jVpQfeCZFQs3CXv635k9Sn-DIZlQgrU8/view"},{title:"Daimyo Responses to American Demands",type:"primary",url:"https://drive.google.com/file/d/1H5bRd2kGVHdlD8tXNk9Yfyx0ZV3YPzX0/view"}],webLinks:[{title:"MIT: Black Ships and Samurai",url:"https://visualizingcultures.mit.edu/black_ships_and_samurai_02/bss_visnav01.html"}]},
  {plate:12,date:"2026-02-02",day:"Monday",week:5,topic:"Meiji Transformation",theme:"Internal revolt",ebrey:"Ch. 20",readings:[{title:"Meiji Primary Sources",author:"Fukuzawa Yukichi",source:"SJT",pages:"669-764",type:"primary",url:"https://drive.google.com/file/d/1t8iJmmg3JQVjZPI5AFiPBQ4FYPw4hu0r/view"}],webLinks:[{title:"Pacific Century Documentary",url:"https://www.youtube.com/watch?v=gURiHVTJX4A"}]},
  {plate:13,date:"2026-02-04",day:"Wednesday",week:5,topic:"Taiping and other rebellions",theme:"Internal revolt",ebrey:null,readings:[{title:"The Crisis Within",author:"Spence",source:"Search for Modern China",type:"secondary",url:"https://drive.google.com/file/d/1DQ6QnVtXRuQ6l-txpOrrXt2XctrHlkZt/view"},{title:"Heavenly Kingdom of Taipings",source:"SCT",type:"primary",url:"https://drive.google.com/file/d/1xX84GfwsR1uXWx12DhztJRKmZRiuQOdC/view"}]},
  {plate:14,date:"2026-02-06",day:"Friday",week:5,topic:"Tonghak Rebellion",theme:"Internal revolt",ebrey:"368-369, 376-377",readings:[{title:"Tonghak Uprisings",source:"SKT",type:"primary",url:"https://drive.google.com/file/d/1iAFLA1nBFcfbgOcfvsaENMy5z4NgRO8_/view"},{title:"Revolutionary Uprising of Tonghak Peasant Army",source:"New History of Korea",type:"secondary",url:"https://drive.google.com/file/d/1I1ObGHD1eoZlci6KmK6s-R9kmp5Q4FND/view"}]},
  {plate:15,date:"2026-02-09",day:"Monday",week:6,topic:"Joseon's Slow Evolution",theme:"Midterm reading period",ebrey:"Ch. 21",readings:[{title:"Encounters with the West / Defense of Orthodoxy",source:"SKT",pages:"117-142, 235-244",type:"primary",url:"https://drive.google.com/file/d/1hu67P1Xb8GDjhIV0xPbd89oHYpWPYWP4/view"}],notes:"Focus on primary sources first"},
  {plate:16,date:"2026-02-11",day:"Wednesday",week:6,topic:"Tonghak in Film",theme:"Midterm reading period",ebrey:null,readings:[],film:{title:"Run High, Run Far",director:"Im Kwontaek",year:1991,url:"https://youtu.be/bVjQcRlXo3Q"}},
  {plate:null,date:"2026-02-13",day:"Friday",week:6,topic:"Midterm Reading Period",theme:"Midterm",ebrey:null,readings:[],noClass:true,assignment:{name:"Project #2",due:"2026-02-15",dueDay:"Sunday"}},
  {plate:17,date:"2026-02-16",day:"Monday",week:7,topic:"Japanese Nationalism",theme:"Rising empires and nationalism",ebrey:"Ch. 22",readings:[{title:"Tokutomi Soho: Nationalist's View",author:"Tokutomi Soho",source:"SJT",pages:"798-811",type:"primary",url:"https://drive.google.com/file/d/1x0zJyCZNq5mbGcCALGMnQzokE6tqnDRf/view"}]},
  {plate:18,date:"2026-02-18",day:"Wednesday",week:7,topic:"Korean Nationalism",theme:"Rising empires and nationalism",ebrey:"Ch. 23",readings:[{title:"Open Letter to Ito / Declaration of Independence",source:"SKT",pages:"294-351",type:"primary",url:"https://drive.google.com/file/d/1ONPlaISIU8ks5gY2SyYnHJVP0R3IFD6X/view"}]},
  {plate:19,date:"2026-02-20",day:"Friday",week:7,topic:"Chinese Nationalism",theme:"Rising empires and nationalism",ebrey:"Ch. 24",readings:[{title:"The True Story of Ah Q",author:"Lu Xun",type:"primary",url:"https://drive.google.com/file/d/1Oz8ZRT_X-FxsSo7olV-H0baSzgxuWEQj/view"}],webLinks:[{title:"Preface to A Call to Arms",url:"https://www.marxists.org/archive/lu-xun/1922/12/03.htm"}]},
  {plate:20,date:"2026-02-23",day:"Monday",week:8,topic:"Civil War and Revolution in China",theme:"War and Revolution",ebrey:"Ch. 25",readings:[{title:"What Women Should Know About Communism",author:"Zhen He",type:"primary",url:"https://drive.google.com/file/d/1ciGgzadhvPK8NV4k3IZHr3n6ESC0_rhb/view"}],webLinks:[{title:"Chen Duxiu",url:"http://afe.easia.columbia.edu/ps/china/chen_duxiu_final_awakening.pdf"},{title:"Chiang Kai-shek",url:"http://afe.easia.columbia.edu/ps/cup/chiang_kaishek_new_life.pdf"},{title:"Mao",url:"http://afe.easia.columbia.edu/special/china_1750_mayfourth.htm#mao"}]},
  {plate:21,date:"2026-02-25",day:"Wednesday",week:8,topic:"The Pacific War",theme:"War and Revolution",ebrey:"Connections 430-438, Ch. 26",readings:[{title:"Japan at War",source:"SMC",pages:"316-333",type:"primary",url:"https://drive.google.com/file/d/1FUV7k2gyZOG2xicHEX96DbmYLB3nS82E/view"},{title:"Oral Histories of the Comfort Women",type:"primary",url:"https://drive.google.com/file/d/1UDrmwTgBEBpVP9tjuBxFnp-qC2XddhEK/view"}]},
  {plate:22,date:"2026-02-27",day:"Friday",week:8,topic:"Rebuilding Japan",theme:"War and Revolution",ebrey:"Ch. 26: 461-470",readings:[{title:"Constitution of Japan (1947)",type:"primary",url:"https://drive.google.com/file/d/1R38azeBeaKG_ronaND9fwxpVSkex0uPT/view"},{title:"The American School",type:"primary",url:"https://drive.google.com/file/d/19_wD1Yex9OlA_IR7geifIvVZJi9aXeqL/view"}],webLinks:[{title:"Tokyo Olympiad",url:"https://www.youtube.com/watch?v=WHt0eAdCCns"}]},
  {plate:23,date:"2026-03-02",day:"Monday",week:9,topic:"Mao and Beyond Mao",theme:"Contemporary East Asia",ebrey:"Ch. 27, 30",readings:[{title:"Let Flowers Bloom / 100 Flowers",type:"primary",url:"https://drive.google.com/file/d/1Jsls0Ii5QR-UfPam-sNpzT3FEmM9RC-3/view"}]},
  {plate:24,date:"2026-03-04",day:"Wednesday",week:9,topic:"Liberation, Division, Rebuilding Korea",theme:"Contemporary East Asia",ebrey:"Ch. 28",readings:[{title:"Cranes",source:"Short Fiction",type:"primary",url:"https://drive.google.com/file/d/1CxK408_GdhApyipkHI83ajbZTK2geTfe/view"},{title:"Five Bandits",source:"Short Fiction",type:"primary",url:"https://drive.google.com/file/d/1n-L259kl8tJQOg22FgCLjvvF3VdX219O/view"}],webLinks:[{title:"Korean Families Reunite",url:"https://www.youtube.com/watch?v=KYjdUeYT49c"},{title:"Gangnam Style",url:"https://www.youtube.com/watch?v=9bZkp7q19f0"}]},
  {plate:25,date:"2026-03-06",day:"Friday",week:9,topic:"Japan rises again",theme:"Contemporary East Asia",ebrey:"Ch. 29",readings:[{title:"Environmental Activism, Feminism",type:"primary",url:"https://drive.google.com/file/d/1apup-PPgM9q7AcDPIyCDAXcnJixQ8URL/view"}],assignment:{name:"Project #3",due:"2026-03-08",dueDay:"Sunday"}},
  {plate:null,date:"2026-03-09",day:"Monday",week:10,topic:"Final presentations",theme:"Student presentations",ebrey:null,readings:[],presentations:true},
  {plate:null,date:"2026-03-11",day:"Wednesday",week:10,topic:"Final presentations",theme:"Student presentations",ebrey:null,readings:[],presentations:true},
  {plate:null,date:"2026-03-13",day:"Friday",week:10,topic:"Final presentations",theme:"Student presentations",ebrey:null,readings:[],presentations:true}
];

var currentPlateIndex = 0;
var timerInterval = null;
var timerSeconds = 600;
var availableWorksheets = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25]; // All plates have worksheets
var availableEnrichment = [7, 8]; // Plates with enrichment data (expand as you generate more)

function openPrintWorksheet() {
  var p = plates[currentPlateIndex];
  if (p && p.plate && availableWorksheets.indexOf(p.plate) >= 0) {
    window.open('print/platebook-' + p.plate + '.html', '_blank');
  }
}

function openEnrichment() {
  var p = plates[currentPlateIndex];
  if (p && p.plate) {
    window.open('print/plate-' + p.plate + '-enrichment.html', '_blank');
  }
}

function updateWorksheetButton() {
  var btn = document.getElementById('printWorksheetBtn');
  var p = plates[currentPlateIndex];
  if (p && p.plate && availableWorksheets.indexOf(p.plate) >= 0) {
    btn.style.display = 'inline-block';
  } else {
    btn.style.display = 'none';
  }
}

function updateEnrichmentButton() {
  var btn = document.getElementById('enrichmentBtn');
  var p = plates[currentPlateIndex];
  if (p && p.plate && availableEnrichment.indexOf(p.plate) >= 0) {
    btn.style.display = 'inline-block';
  } else {
    btn.style.display = 'none';
  }
}

function renderRoster() {
  var html = "";
  for (var i = 0; i < students.length; i++) {
    var s = students[i];
    var displayName = s.preferredName || s.firstName;
    html += '<div class="student-nameplate">';
    html += '<img src="' + s.photo + '" onerror="this.src=\'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%23ddd%22/><text x=%2250%22 y=%2260%22 text-anchor=%22middle%22 font-size=%2240%22 fill=%22%23999%22>' + displayName.charAt(0) + '</text></svg>\'">';
    html += '<div class="name">' + displayName + '</div>';
    if (s.pronouns) html += '<div class="pronouns">' + s.pronouns + '</div>';
    html += '</div>';
  }
  document.getElementById("rosterRow").innerHTML = html;
}

function formatDate(d) {
  var dt = new Date(d + "T12:00:00");
  return dt.toLocaleDateString("en-US", {month: "short", day: "numeric"});
}

function formatFullDate(d) {
  var dt = new Date(d + "T12:00:00");
  return dt.toLocaleDateString("en-US", {weekday: "long", month: "long", day: "numeric", year: "numeric"});
}

function initDropdown() {
  var html = "";
  for (var i = 0; i < plates.length; i++) {
    var p = plates[i];
    var cls = "plate-option";
    if (i === currentPlateIndex) cls += " active";
    if (p.noClass) cls += " no-class";
    var label = p.plate ? "Day " + p.plate + ": " : "";
    label += p.topic.length > 40 ? p.topic.substring(0, 40) + "..." : p.topic;
    html += '<div class="' + cls + '" onclick="loadPlate(' + i + ')">';
    html += '<span>' + label + '</span>';
    html += '<span class="date">' + p.day + ' ' + formatDate(p.date) + '</span>';
    html += '</div>';
  }
  document.getElementById("plateDropdown").innerHTML = html;
}

async function loadPlate(i) {
  if (i < 0 || i >= plates.length) return;
  currentPlateIndex = i;
  var p = plates[i];

  updateWorksheetButton();
  updateEnrichmentButton();
  document.getElementById("currentPlate").textContent = p.plate ? "Day " + p.plate : p.topic;
  document.getElementById("weekTheme").textContent = "Week " + p.week + " ¬∑ " + (p.theme || "");
  document.getElementById("plateTitle").textContent = p.plate ? "Day " + p.plate + ": " + p.topic : p.topic;
  document.getElementById("plateDate").textContent = formatFullDate(p.date);

  var eb = document.getElementById("ebreyRef");
  if (p.ebrey) {
    eb.innerHTML = 'üìñ <a href="https://drive.google.com/file/d/1UdX-0vMwX8OrfNpK_DtJuU-e8gL3kROs/view?usp=sharing" target="_blank" style="color:#f0e6d0;text-decoration:underline;">Ebrey: ' + p.ebrey + '</a>';
    eb.style.display = "inline-block";
  } else {
    eb.style.display = "none";
  }

  // Load prep data and render
  var prepData = p.plate ? await loadPrepData(p.plate) : null;
  renderMainWithPrep(p, prepData);
  renderSidebar(p, i);

  var opts = document.querySelectorAll(".plate-option");
  for (var j = 0; j < opts.length; j++) {
    opts[j].className = opts[j].className.replace(" active", "");
    if (j === i) opts[j].className += " active";
  }
  document.getElementById("plateDropdown").className = "plate-dropdown";
}

function renderMainWithPrep(p, prepData) {
  var m = document.getElementById("prepMain");

  if (p.noClass) {
    m.innerHTML = '<div class="no-class-banner">üö´ No Class ‚Äî ' + p.topic + '</div>';
    return;
  }
  if (p.presentations) {
    m.innerHTML = '<div class="no-class-banner" style="background:#e3f2fd;color:#1565c0">üé§ Student Presentations</div>';
    return;
  }

  var h = "";

  // 1. MAP (first, for geographic context) - skip if custom map exists
  if (prepData && prepData.map && !prepData.customMapUrl) {
    h += renderMap(prepData.map);
  }

  // 2. TODAY'S READINGS (right under map)
  if (p.readings && p.readings.length > 0) {
    h += '<div class="section-title">Today\'s Readings</div>';
    for (var i = 0; i < p.readings.length; i++) {
      var r = p.readings[i];
      var tc = r.type || "primary";
      var tl = r.type === "theoretical" ? "Theoretical" : (r.type === "secondary" ? "Secondary" : "Primary");
      h += '<a class="reading-card ' + tc + '" href="' + r.url + '" target="_blank">';
      h += '<div class="type-badge">' + tl + '</div>';
      h += '<div class="title">' + r.title + '</div>';
      if (r.author) h += '<div class="author">' + r.author + '</div>';
      if (r.source || r.pages) {
        h += '<div class="source">' + (r.source || "") + (r.pages ? " ¬∑ pp. " + r.pages : "") + '</div>';
      }
      h += '</a>';
    }
  }

  // Web links
  if (p.webLinks && p.webLinks.length > 0) {
    h += '<div class="web-links">';
    for (var j = 0; j < p.webLinks.length; j++) {
      var l = p.webLinks[j];
      h += '<a class="web-link" href="' + l.url + '" target="_blank">üîó ' + l.title + '</a>';
    }
    h += '</div>';
  }

  // 3. EXECUTIVE SUMMARY (right after readings)
  var summaryText = prepData && (prepData.executiveSummary || prepData.overallSynthesis);
  if (summaryText) {
    h += '<div class="prep-section"><h3>Executive Summary <span class="sage-badge">Sage</span></h3>';
    // Custom map iframe (embedded in executive summary)
    if (prepData.customMapUrl) {
      h += '<div class="custom-map-embed"><iframe src="' + prepData.customMapUrl + '?v=' + Date.now() + '" style="width:100%;height:400px;border:none;border-radius:10px;margin-bottom:16px;"></iframe></div>';
    }
    h += '<div class="prep-summary">' + summaryText + '</div></div>';
  }

  // 4. Film (if any)
  if (p.film) {
    h += '<div class="section-title">Today\'s Film</div>';
    h += '<div class="film-box"><strong>üé¨ ' + p.film.title + '</strong> (' + p.film.year + ')<br>';
    h += 'Director: ' + p.film.director + '<br>';
    h += '<a href="' + p.film.url + '" target="_blank">‚ñ∂ Watch Film ‚Üí</a></div>';
  }

  // 5. REST OF PREP CONTENT
  if (prepData) {
    h += renderPrepContent(prepData, p);
  }

  if (!h) h = '<p style="color:var(--text-muted);padding:20px">No readings for this day.</p>';
  m.innerHTML = h;

  // Initialize map if prep data has map (but not if custom map iframe is used)
  if (prepData && prepData.map && !prepData.customMapUrl) {
    initMap(prepData.map);
  }
}

function renderMain(p) {
  renderMainWithPrep(p, null);
}

function renderSidebar(p, i) {
  var s = document.getElementById("prepSidebar");
  var h = "";
  
  if (p.special) {
    h += '<div class="section-title">‚ö†Ô∏è Special Instructions</div>';
    h += '<div class="notes-box special">' + p.special + '</div>';
  }
  
  if (p.notes) {
    h += '<div class="section-title">Notes</div>';
    h += '<div class="notes-box">' + p.notes + '</div>';
  }
  
  if (p.assignment) {
    h += '<div class="assignment-box">';
    h += '<div class="label">üìå Assignment Due</div>';
    h += '<div class="name">' + p.assignment.name + '</div>';
    h += '<div class="due">' + p.assignment.dueDay + ', ' + formatDate(p.assignment.due) + '</div>';
    h += '</div>';
  }
  
  var ni = i + 1;
  while (ni < plates.length && plates[ni].noClass) ni++;
  var nx = plates[ni];
  
  h += '<div class="section-title">Coming Up Next</div>';
  if (nx) {
    h += '<div class="upcoming-card">';
    h += '<div class="plate-num">' + (nx.plate ? "Day " + nx.plate : nx.topic) + '</div>';
    h += '<div class="topic">' + nx.topic + '</div>';
    h += '<div class="date">' + nx.day + ', ' + formatDate(nx.date) + '</div>';
    h += '</div>';
  } else {
    h += '<div class="upcoming-card"><div class="topic">End of Course</div></div>';
  }
  
  s.innerHTML = h;
}

function prevPlate() { loadPlate(currentPlateIndex - 1); }
function nextPlate() { loadPlate(currentPlateIndex + 1); }

function togglePlateDropdown() {
  var dd = document.getElementById("plateDropdown");
  dd.className = dd.className.indexOf("open") >= 0 ? "plate-dropdown" : "plate-dropdown open";
}

function updateTimerDisplay() {
  var m = Math.floor(timerSeconds / 60);
  var s = timerSeconds % 60;
  document.getElementById("timerDisplay").textContent = 
    (m < 10 ? "0" : "") + m + ":" + (s < 10 ? "0" : "") + s;
}

function startTimer() {
  if (timerInterval) return;
  timerInterval = setInterval(function() {
    timerSeconds--;
    updateTimerDisplay();
    if (timerSeconds <= 0) {
      clearInterval(timerInterval);
      timerInterval = null;
      alert("Time!");
    }
  }, 1000);
}

function pauseTimer() {
  clearInterval(timerInterval);
  timerInterval = null;
}

function resetTimer() {
  pauseTimer();
  timerSeconds = 600;
  updateTimerDisplay();
}

function setTimer(m) {
  pauseTimer();
  timerSeconds = m * 60;
  updateTimerDisplay();
}

function openTimerModal() {
  document.getElementById("timerModal").className = "modal-overlay active";
}

function closeTimerModal() {
  document.getElementById("timerModal").className = "modal-overlay";
}

function findToday() {
  var t = new Date().toISOString().split("T")[0];
  // Find today's class or the next upcoming class
  for (var i = 0; i < plates.length; i++) {
    if (plates[i].date === t) return i;
    if (plates[i].date > t) return i; // Return next upcoming day
  }
  return plates.length - 1; // If past all dates, return last
}

document.addEventListener("click", function(e) {
  if (!e.target.closest(".plate-selector")) {
    document.getElementById("plateDropdown").className = "plate-dropdown";
  }
});

document.getElementById("timerModal").addEventListener("click", function(e) {
  if (e.target === this) closeTimerModal();
});

var prepCache = {};
var currentMap = null;

function renderMap(mapData) {
  if (!mapData || !mapData.locations || !mapData.locations.length) return '';

  var h = '<div class="prep-section"><h3>Map</h3>';
  h += '<div class="map-container"><div id="prep-map"></div></div>';
  h += '<div class="map-legend">';

  var colors = {'capital': '#e63946', 'city': '#457b9d', 'region': '#2a9d8f', 'battle': '#f4a261', 'other': '#6c757d'};
  var usedTypes = {};
  for (var i = 0; i < mapData.locations.length; i++) {
    usedTypes[mapData.locations[i].type || 'other'] = true;
  }
  for (var type in usedTypes) {
    var label = type.charAt(0).toUpperCase() + type.slice(1);
    h += '<div class="map-legend-item"><div class="map-legend-dot" style="background:' + colors[type] + '"></div>' + label + '</div>';
  }
  h += '</div></div>';

  return h;
}

function initMap(mapData) {
  if (!mapData || !mapData.locations || !mapData.locations.length) return;

  setTimeout(function() {
    var mapEl = document.getElementById('prep-map');
    if (!mapEl) return;

    if (currentMap) {
      currentMap.remove();
      currentMap = null;
    }

    var center = mapData.center || [35, 115];
    var zoom = mapData.zoom || 4;

    currentMap = L.map('prep-map').setView(center, zoom);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(currentMap);

    var colors = {'capital': '#e63946', 'city': '#457b9d', 'region': '#2a9d8f', 'battle': '#f4a261', 'other': '#6c757d'};

    for (var i = 0; i < mapData.locations.length; i++) {
      var loc = mapData.locations[i];
      var color = colors[loc.type] || colors.other;

      var marker = L.circleMarker([loc.lat, loc.lng], {
        radius: loc.type === 'capital' ? 10 : 7,
        fillColor: color,
        color: '#fff',
        weight: 2,
        opacity: 1,
        fillOpacity: 0.8
      }).addTo(currentMap);

      var popup = '<strong>' + loc.name + '</strong>';
      if (loc.nameChinese) popup += ' (' + loc.nameChinese + ')';
      if (loc.description) popup += '<br><span style="font-size:11px">' + loc.description + '</span>';
      marker.bindPopup(popup);
    }
  }, 100);
}

async function loadPrepData(plateNum) {
  if (!plateNum) return null;
  if (prepCache[plateNum]) return prepCache[plateNum];
  try {
    var response = await fetch("prep/execsummary-" + plateNum + ".json");
    if (!response.ok) return null;
    prepCache[plateNum] = await response.json();
    return prepCache[plateNum];
  } catch (e) {
    console.log("No prep data for plate " + plateNum);
    return null;
  }
}

function renderPrepContent(data, p) {
  if (!data) {
    return null; // No prep data, will show readings instead
  }

  var h = '';

  // TRIMMED: Removed verbose Reading Analyses section
  // Map and Executive Summary are rendered in renderMainWithPrep

  // Key Passages (top 3 only)
  if (data.keyPassages && data.keyPassages.length) {
    h += '<div class="prep-section"><h3>Key Passages</h3>';
    var maxPassages = Math.min(data.keyPassages.length, 3);
    for (var j = 0; j < maxPassages; j++) {
      var kp = data.keyPassages[j];
      h += '<div class="passage-card"><blockquote>"' + kp.quote + '"</blockquote>';
      h += '<div class="source">‚Äî ' + kp.source + (kp.page ? ', p. ' + kp.page : '') + '</div></div>';
    }
    h += '</div>';
  }

  // Key Questions (top 2 only)
  if (data.keyQuestions && data.keyQuestions.length) {
    h += '<div class="prep-section"><h3>Key Questions</h3>';
    var maxQuestions = Math.min(data.keyQuestions.length, 2);
    for (var q = 0; q < maxQuestions; q++) {
      var kq = data.keyQuestions[q];
      h += '<div class="question-card"><div class="q">' + (q+1) + '. ' + kq.question + '</div>';
      h += '<div class="a">' + kq.talkingPoints + '</div></div>';
    }
    h += '</div>';
  }

  // Timeline (compact)
  if (data.timeline && data.timeline.length) {
    h += '<div class="prep-section"><h3>Timeline</h3><table class="timeline-table"><tr><th>Date</th><th>Event</th></tr>';
    for (var t = 0; t < data.timeline.length; t++) {
      h += '<tr><td>' + data.timeline[t].date + '</td><td>' + data.timeline[t].event + '</td></tr>';
    }
    h += '</table></div>';
  }

  // Connections (condensed)
  if (data.connections) {
    h += '<div class="prep-section"><h3>Connections</h3>';
    if (data.connections.fromPrevious) h += '<div class="connection-item"><strong>‚Üê Previous:</strong> ' + data.connections.fromPrevious + '</div>';
    if (data.connections.toNext) h += '<div class="connection-item"><strong>‚Üí Next:</strong> ' + data.connections.toNext + '</div>';
    h += '</div>';
  }

  return h;
}

window.onload = function() {
  renderRoster();
  initDropdown();
  loadPlate(findToday());
  updateTimerDisplay();
};
</script>
</body>
</html>
